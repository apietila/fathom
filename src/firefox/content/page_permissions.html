<!--
 * ***** BEGIN LICENSE BLOCK *****
 *
 * Copyright (c) 2011-2012 International Computer Science Institute (ICSI).
 * All rights reserved.
 *
 * See LICENSE for license and terms of usage. 
 *
 * ***** END LICENSE BLOCK *****
-->

<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
</head>
<style>
  .pad {
    padding: 10px;
  }
  body {
    font-size: 87%;
    margin: 0;
    font-family: sans-serif;
  }
  #header {
    font-size: 1.5em;
    background-color: #fedede;
    border-bottom: 1px solid #cebebe;
  }
  #content {
  	background-color: #fafafa;
  }
  #url {
    background-color: #fafafa;
    border-bottom: 1px solid #dedede;
    font-weight: bold;
  }
  #buttontable {
    margin-top : 2em;
    width : 100%;
  }
  #buttontable td {
    width : 50%;
    text-align: center;
  }
  .button {
    font-size: 2.0em
  }
</style>
<script>
  var args = window.arguments[0].wrappedJSObject;
  var url = args['url'];
  var callback = args['callback'];
  var requested_apis = args['requested_apis'];
  var requested_destinations = args['requested_destinations'];

  var apiDesc = {
      'proto': 'APIs allow DNS, mDNS, HTTP and UPnP protocol access.',
      'socket': 'APIs allow low-level socket communication.',
      'system': 'APIs allow access to system utilities.',
      'tools': 'APIs allow access to browser based delay, loss and bandwidth measurement tools.',
      'baseline': 'APIs allow access to continuous baseline performance measurements collected on the background.'
  };

  function writeBody() {
    // Reminder: certainly don't want document.write or .innerHtml for XSS reasons.
    // TODO: Even though we're using textContent, we should also filter characters.

    document.getElementById('url').textContent = url;
    //document.getElementById('url').textContent = 'http://www.example.com/foo/bar.html';

    if (requested_apis) {
      var ul = document.getElementById('requested_apis');
      for (var apimodule in requested_apis) {
        var apifunc = requested_apis[apimodule];
        var item = document.createElement('li');
        item.textContent = apimodule + '.' + apifunc + " : " + apiDesc[apimodule];
        ul.insertBefore(item, null);
      }
      document.getElementById('apis').style.display = "block";
    }

    if (requested_destinations) {
      var ul = document.getElementById('requested_destinations');
      for (var destination in requested_destinations) {
        var item = document.createElement('li');

        var desc = '';
        if (requested_destinations[destination].mdns) {
           desc = ' - hosts found using mDNS service discovery';
        }
        if (requested_destinations[destination].upnp) {
           desc = ' - hosts found using uPnP discovery';
        }
        if (requested_destinations[destination].lan) {
           desc = ' - hosts in the local network';
        }
        if (requested_destinations[destination].origin) {
           destination = requested_destinations[destination].host;
           desc = ' - the page origin';
        }

        item.textContent = destination + desc;
        ul.insertBefore(item, null);
      }
      document.getElementById('destinations').style.display = "block";
    }
  }

  function permissionsGranted() {
    setTimeout(callback, 0, {result : 'once'});
    window.close();
  }

  // TODO: remove?
  function permissionsGrantedAlways() {
    setTimeout(callback, 0, {result : 'always'});
    window.close();
  }

  function permissionsDenied() {
    setTimeout(callback, 0, {result : 'no'});
    window.close();
  }

</script>
<body onLoad="writeBody(); document.getElementById('deny').focus();">

<div id="header" class="pad">
  A web page is requesting Fathom privileges.
</div>

<div id="url" class="pad"></div>

<div id="content" class="pad">

  <div id="apis" style="display:none">
    The page wants to use these APIs:
    <ul id="requested_apis"></ul>
  </div>

  <div id="destinations" style="display:none">
    The page wants to communicate with:
    <ul id="requested_destinations"></ul>
  </div>


  <table id="buttontable">
    <tr>
      <td>
        <form action="javascript:permissionsDenied()">
          <input type="submit" value="Deny" id="deny" class="button" />
        </form>
      </td>
      <td>
        <form action="javascript:permissionsGranted()">
          <input type="submit" value="Allow Once" id="allow" class="button" />
        </form>
      </td>
      <td>
        <form action="javascript:permissionsGrantedAlways()">
          <input type="submit" value="Allow Always" id="allowalways" class="button" />
        </form>
      </td>
    </tr>
  </table>


</div>

</body>
</html>
